---

# Copyright (c) 2018 Kabolt
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: "Check if certificate already exists for {{ cert_item.domains | first }}"
  stat:
    path: "/etc/letsencrypt/live/{{ cert_item.domains | first }}/cert.pem"
  register: certificate

- name: Stop services to let certbot generate a certificate
  service:
    name: "{{ item }}"
    state: stopped
  when:
    - not certificate.stat.exists
    - certbot_standalone_stop_services | length > 0
  with_items: "{{ certbot_standalone_stop_services }}"

- name: "Generate new certificate in standalone mode for {{ cert_item.domains | first }}"
  shell: "{{ certbot_standalone_gen_command }}"
  when:
    - not certificate.stat.exists
    - cert_item.mode is undefined or (cert_item.mode is defined and cert_item.mode == 'standalone')

- name: "Generate new certificate in webroot mode for {{ cert_item.domains | first }}"
  shell: "{{ certbot_webroot_gen_command }}"
  when:
    - not certificate.stat.exists
    - cert_item.mode is defined and cert_item.mode == 'webroot'

- name: Start services after certificates generation
  service:
    name: "{{ item }}"
    state: started
  when:
    - not certificate.stat.exists
    - certbot_standalone_stop_services | length > 0
  with_items: "{{ certbot_standalone_stop_services }}"

- name: "Certificate concatenation for {{ cert_item.domains | first }}"
  shell: "cat /etc/letsencrypt/live/{{ cert_item.domains | first }}/fullchain.pem /etc/letsencrypt/live/{{ cert_item.domains | first }}/privkey.pem > {{ cert_item.concatenate }}"
  when:
    - not certificate.stat.exists
    - cert_item.concatenate is defined
    - cert_item.concatenate | length > 0
